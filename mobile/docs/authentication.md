# Аутентификация в мобильном клиенте

Мобильный Matrix Messenger поддерживает несколько способов входа, включая пароль, одноразовые коды, SSO и QR-токены. Этот документ описывает доступные сценарии, требования безопасности и рекомендации по отзыву сессий.

## Стандартный вход по паролю

- Пользователь вводит URL homeserver'а, логин и пароль.
- При необходимости можно указать одноразовый код TOTP.
- Если homeserver требует MFA, клиент отобразит запрос с указанием активной сессии и позволит повторно ввести код.
- При успешном входе клиент автоматически очищает состояние MFA и закрывает активные QR-подключения.

## Вход по одноразовому токену

- Токен можно вставить вручную или отсканировать через QR-код.
- Поддерживаются ссылки вида `matrix:`, `https://app.element.io/#/loginToken/<token>` и URI с параметром `loginToken`.
- После успешной авторизации токен очищается из формы, чтобы избежать повторного использования.
- При ошибке отображается сообщение, и токен можно ввести повторно.

## Вход через SSO

1. Клиент формирует redirect URL на основе схемы приложения (`expo-linking`) и открывает страницу SSO в браузере.
2. После подтверждения сервер перенаправляет пользователя обратно с `loginToken`.
3. Токен можно автоматически распознать через deep-link, либо вставить вручную в форму «Токен входа».

> **Важно:** Убедитесь, что homeserver доверяет указанной схеме перенаправления. При необходимости обновите whitelist редиректов на стороне сервера.

## Вход через QR-код

- Кнопка «Сгенерировать QR» запрашивает у homeserver'а одноразовую сессию и отображает Matrix URI.
- Клиент начинает опрос сервера, ожидая подтверждения доверенным устройством.
- Если QR-код истёк или был отменён, пользователь увидит соответствующее уведомление.
- Кнопка «Сканер QR» открывает камеру (через `expo-camera`) и позволяет считать токен другого устройства.
- Сканер отображает статус и позволяет повторить попытку без перезапуска приложения.

### Fallback через браузер

Если homeserver не поддерживает QR-подтверждение, в интерфейсе отображается fallback-ссылка. Пользователь может открыть её в браузере и завершить выдачу токена вручную.

## Отзыв и подтверждение сессий

- Любая активная QR-сессия может быть отменена кнопкой «Отменить» или закрытием экрана входа.
- При выходе (`logout`) клиент отправляет запрос на `logout` и освобождает все ресурсы, включая QR-сессии.
- Рекомендуется регулярно проверять список устройств в настройках безопасности и отзывать неиспользуемые токены.
- Для аварийного отзыва токена используйте форму «Войти по токену» с просроченным токеном — клиент сообщит об ошибке, что позволит убедиться в его недействительности.

## Советы по безопасности

- Никогда не делитесь `loginToken` и QR-кодами. Они дают полный доступ к аккаунту.
- При появлении запроса на TOTP убедитесь, что уведомление действительно относится к вашей попытке входа.
- Если браузер открылся неожиданно (SSO/QR fallback), отмените сессию в приложении и смените пароль.
- После настройки нового устройства подтвердите его в настройках безопасности, чтобы ограничить выдачу токенов только доверенным клиентам.
