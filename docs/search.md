# –ü–æ–∏—Å–∫ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å Matrix Messenger

–õ–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∞–∂–µ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ homeserver'–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–¥–±–æ—Ä–∫–∏. –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –≤ –¥–µ—Å–∫—Ç–æ–ø-–≤–µ—Ä—Å–∏–∏ (—á–µ—Ä–µ–∑ SQLite, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π Tauri) –∏ –≤ –≤–µ–±-—Å–±–æ—Ä–∫–µ (—á–µ—Ä–µ–∑ IndexedDB).

## –†–µ–∂–∏–º—ã –ø–æ–∏—Å–∫–∞

### 1. –ü–æ–∏—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Matrix
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∑–∞–ø—Ä–æ—Å –≤ `_matrix/client/v3/search`.
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é (`next_batch`), –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ/–ø–æ—Å–ª–µ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ –¥–∞—Ç–µ.
* –§–∏–ª—å—Ç—Ä—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—É: –∫–æ–º–Ω–∞—Ç—ã, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏, —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–µ—Ä–∏–æ–¥, –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞.
* –ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ, –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –æ—Ç homeserver'–∞ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–µ `smart:*` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å.

### 2. –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
* –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö ‚Äî `mediaIndexService`: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã —Ç–µ–ª–∞, —Å—Å—ã–ª–∫–∏, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, –º–µ—Ç–∫–∏, —Ä–µ–∞–∫—Ü–∏–∏ –∏ –º–µ–¥–∏–∞-–∞—Ç—Ä–∏–±—É—Ç—ã.
* –í Tauri –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ SQLite (`search_index.sqlite3` –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è). –ù–∞ –≤–µ–±–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è IndexedDB (`matrix-messenger-index`).
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: –∫–æ–º–Ω–∞—Ç—ã, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏, –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç, –Ω–∞–ª–∏—á–∏–µ –≤–ª–æ–∂–µ–Ω–∏–π, —Ç–∏–ø –≤–ª–æ–∂–µ–Ω–∏—è (–∏–∑ `m.image`, `m.video`, `m.file`, —Å—Å—ã–ª–∫–∏), –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.
* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (`smart:important`, `smart:mentions`) –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –≤—ã–±–æ—Ä–∫–∏ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.

## –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞

1. **–ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è** ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ–º–Ω–∞—Ç—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ç–∫—Ç–∏–ª–ª –ø–æ —Ç–∞–π–º–ª–∞–π–Ω—É (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã `backfillLimit` –∏ `step`).
2. **–û–Ω–ª–∞–π–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `RoomEvent.Timeline` –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ SQLite/IndexedDB.
3. **–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è** ‚Äî –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–Ω–∞—Ç—ã –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, —á—Ç–æ–±—ã –ø–æ–∏—Å–∫ –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.
4. **–û—á–∏—Å—Ç–∫–∞** ‚Äî –≤—ã–∑–æ–≤ `mediaIndexService.clear(roomId)` —É–¥–∞–ª—è–µ—Ç –∫–µ—à –∫–æ–º–Ω–∞—Ç—ã –∏–∑ –ø–∞–º—è—Ç–∏, localStorage, IndexedDB/SQLite.

> ‚ö†Ô∏è –ò–Ω–¥–µ–∫—Å —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –¥–æ—Å—Ç—É–ø–Ω—ã–π –≤ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ E2EE-–∫–æ–º–Ω–∞—Ç –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º.

## –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–¥–±–æ—Ä–∫–∏

–õ–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–¥–±–æ—Ä–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:

| –ü–æ–¥–±–æ—Ä–∫–∞ | –£—Å–ª–æ–≤–∏–µ | –ü–æ–∏—Å–∫ | –¢–æ–∫–µ–Ω |
|----------|---------|-------|-------|
| **–í–∞–∂–Ω–æ** | –°–æ–æ–±—â–µ–Ω–∏—è —Å —Ç–µ–≥–æ–º `important`, —Ä–µ–∞–∫—Ü–∏—è–º–∏ ‚≠ê/üî•/‚ùó | –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å | `smart:important` |
| **–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è** | –°–æ–æ–±—â–µ–Ω–∏—è —Å `@<–≤–∞—à_–ª–æ–≥–∏–Ω>` –ª–∏–±–æ —Ç–æ–∫–µ–Ω–∞–º–∏ –ø—Ä–æ—Ñ–∏–ª—è | –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å | `smart:mentions` |

–ö–Ω–æ–ø–∫–∏ –ø–æ–¥–±–æ—Ä–æ–∫ –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ `smart:*`, —á—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç `searchService` —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å.

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—ë–º–æ–º –∫—ç—à–∞

* SQLite –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ (`INSERT ... ON CONFLICT`).
* IndexedDB —Ö—Ä–∞–Ω–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –º–µ–¥–∏–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö object store. –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç—ã –≤—ã–∑–æ–≤–∏—Ç–µ `mediaIndexService.clear` ‚Äî –æ–Ω –æ—á–∏—Å—Ç–∏—Ç –æ–±–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
* –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–æ—Å—Ç–∞ –±–∞–∑—ã –º–æ–∂–Ω–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å `VACUUM` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ devtools Tauri) –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å `backfillLimit` –ø—Ä–∏ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–æ–ª—å—à–∏—Ö –∫–æ–º–Ω–∞—Ç.

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

* –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–∫—Ä—É–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ/–ø–æ—Å–ª–µ). –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ homeserver'—É.
* –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ª–∏—á–Ω—ã–µ –æ—Ç `m.image`, `m.video`, `m.file` –∏ —Å—Å—ã–ª–æ–∫, —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –º–æ–≥—É—Ç –¥–∞—Ç—å —É—Å–µ—á—ë–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
* –ò–Ω–¥–µ–∫—Å –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É.
* –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –æ—Ñ—Ñ–ª–∞–π–Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –ø–æ–ª–æ–Ω –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–æ–Ω–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

* **–í–µ–±** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É Application ‚Üí IndexedDB, –±–∞–∑–∞ `matrix-messenger-index`.
* **Desktop (Tauri)** ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `search_index.sqlite3` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ DB Browser) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã `message_index` –∏ `media_index`.
* –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è `Failed to persist index via Tauri` –∏–ª–∏ `Local persistent query failed` —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å SQLite/IndexedDB.
