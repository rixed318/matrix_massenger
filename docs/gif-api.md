# GIF API интеграция

Matrix Messenger использует Tenor (совместимый с GIPHY) в качестве публичного источника анимированных изображений. Модуль `src/services/gifService.ts` инкапсулирует работу с API, кеширование и синхронизацию избранного. Ниже перечислены основные моменты настройки и эксплуатации.

## Конфигурация

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|------------------------|
| `VITE_GIF_API_KEY` | Ключ доступа Tenor/GIPHY. Обязателен для запросов к внешнему API. | — |
| `VITE_GIF_API_BASE` | Базовый URL провайдера. Можно использовать корпоративный прокси. | `https://tenor.googleapis.com/v2` |
| `VITE_GIF_CLIENT_KEY` | Идентификатор клиента, отображается в аналитике Tenor. | `matrix-messenger` |

Создайте файл `.env.local` (или задайте переменные окружения перед запуском `pnpm dev`/`pnpm tauri dev`). После изменения значений перезапустите дев-сервер Vite или Tauri, чтобы конфигурация применилась.

## Функциональность клиента

- **Поиск и тренды.** Методы `searchGifs` и `getTrendingGifs` поддерживают курсоры (`pos`) и лимит выдачи. Первый экран хранится в кэше 30 минут.
- **История запросов.** Последние 15 поисковых фраз сохраняются в IndexedDB (веб) или в Tauri Store (`gif-cache.store`). Историю можно очищать из интерфейса.
- **Избранное.** Локальные избранные GIF синхронизируются с Matrix account data (`com.econix.gif_favorites`) и автоматически попадают на другие устройства. При конфликте выигрывает запись с более свежим `addedAt`.
- **Кэширование.** Все страницы (тренды/поиск) и вспомогательные структуры записываются в IndexedDB (`matrix-messenger-gifs`) или в файл Tauri Store. При сбое сети компонент может отобразить данные из кэша.
- **Обработка ошибок.** Сервис перехватывает HTTP ошибки (включая 4xx/5xx, ограничение по RPS) и возвращает сообщение в интерфейс. Если есть кэш, пользователь увидит актуальные результаты и предупреждение.

## Ограничения и политика использования

- **Лимиты Tenor.** Бесплатный ключ поддерживает до ~10 000 запросов в сутки и до 5 RPS. Для больших нагрузок запросите расширенную квоту или используйте корпоративный тариф GIPHY.
- **Контент.** Убедитесь, что вы соблюдаете лицензионные требования провайдера (Tenor требует отображать логотип и ссылку в соответствии с [Guidelines](https://tenor.com/guidelines)). Добавьте собственный баннер или ссылку, если публикуете приложение в сторы.
- **Безопасность.** Ключ хранится только локально и не отправляется в Matrix. Для продакшн-сборок рекомендуем использовать секреты CI/CD или прокси, который добавляет API-ключ на бэкенде.
- **GDPR/локальные нормы.** Если приложение дистрибуцируется в регионах с ограничениями на контент, настройте фильтры Tenor (e.g. `contentfilter=medium`). При необходимости можно проксировать запросы через ваш сервер и внедрять дополнительные проверки.

## Отладка

- При статусах `403`/`429` проверяйте корректность `VITE_GIF_API_KEY` и лимиты Tenor. Компонент `StickerGifPicker` показывает подробное сообщение в верхней части вкладки.
- В Tauri логи `gifService` выводятся в консоль devtools. В вебе — в `console` браузера.
- Чтобы сбросить локальный кэш, удалите IndexedDB `matrix-messenger-gifs` или файл `gif-cache.store` (на десктопе).

## Расширение интеграции

- **Альтернативный провайдер.** Можно заменить базовый URL на свой микросервис (например, прокси к GIPHY/RedGIFs). Достаточно вернуть Tenor-совместимый ответ и настроить `VITE_GIF_API_BASE`.
- **Модерация.** Добавьте пред- или пост-фильтрацию в `gifService.ts` (например, по ключевым словам) перед отображением GIF пользователю.
- **Локальные пакеты.** Если требуется полностью офлайн-режим, можно дополнить сервис fallback-набором GIF и отключать сетевые запросы при отсутствии ключа.
