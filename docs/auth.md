# Аутентификация и passkey в Matrix Messenger

Этот документ описывает, как клиент обрабатывает авторизацию пользователей, интерактивные этапы (`m.login.*`) и работу с аппаратными ключами/WebAuthn.

## Базовый поток входа

1. Пользователь выбирает тип подключения на экране входа и указывает MXID/пароль.
2. Клиент вызывает `/login` с типом `m.login.password`. При необходимости запускается `resolveHomeserverBaseUrl`, чтобы работать с каноническим базовым URL homeserver'а.
3. После успешного ответа выполняется инициализация `MatrixClient`: Rust-crypto, outbox, Secure Cloud профиль и запуск синхронизации.

## Поддержка TOTP (`m.login.totp`)

- Если homeserver возвращает интерактивный ответ с этапом `m.login.totp`, на форме входа появляется поле ввода одноразового кода.
- Клиент повторяет запрос `/login`, добавляя `auth: { type: 'm.login.totp', code, session }`.
- При неверном коде отображается понятная ошибка и можно ввести новый код.

## Passkey / WebAuthn (`m.login.webauthn`, `m.login.passkey`)

- Когда homeserver требует один из этих этапов, `matrixService.login` автоматически вызывает `navigator.credentials.get` с параметрами, которые пришли в `data.params` ответа Matrix.
- Пользователю не нужно выполнять дополнительные действия: браузер/Tauri выводит нативное окно подтверждения.
- Ответ WebAuthn сериализуется в base64url и отправляется обратно на сервер как `auth: { type, session, response }`.
- В случае отказа/ошибки отображается текст ошибки (например, «Проверка passkey отменена.»).

## Регистрация аккаунта с passkey

- Метод `matrixService.register` поддерживает интерактивные этапы `m.login.webauthn` во время регистрации.
- Если сервер требует аппаратный ключ, клиент запускает `navigator.credentials.create`, а полученный credential сохраняется до завершения регистрации.
- После успешной регистрации выполняется обычный вход, и passkey добавляется в локальное хранилище.

## Управление устройствами passkey

- На экране входа добавлен блок «Passkey устройства». Он показывает список сохранённых ключей для комбинации homeserver + логин и позволяет удалять записи.
- В Tauri-версии данные сохраняются в защищённом сторе (`secure_credentials.store`) через команды `save_passkey_device`, `list_passkey_devices`, `touch_passkey_device`, `remove_passkey_device`.
- В веб-версии (без Tauri) используется внутренняя in-memory реализация, чтобы интерфейс продолжал работать.

## Действия по умолчанию

- Если passkey ещё не зарегистрирован, сервер всё равно может требовать пароли (fallback-поток «пароль → WebAuthn»).
- При использовании автологина пасски входят в тот же стор, что и токены — новый логин автоматически обновит время последнего использования устройства.

