# Secure Cloud: локальные ML-детекторы

Локальный ML-детектор предназначен для оперативной классификации исходящих и входящих сообщений без передачи данных в облако. Он дополняет эвристические проверки и используется автоматически при включённом премиум-режиме Secure Cloud.

## Регистрация детекторов

- Для единообразной конфигурации всех источников сигналов доступен интерфейс `registerDetector`. Он позволяет объявить детектор типа `ml` или `llm`, указать доступные модели (ONNX, локальные Transformers, внешние API) и задать настройки по языкам (`languageOverrides`).
- Метаданные моделей содержат техническое описание (путь к артефакту, endpoint внешнего API, поддерживаемые языки, произвольные параметры). Они автоматически попадают в каталог, используемый интерфейсом подключения и настройками безопасности.
- При регистрации локального детектора (см. `registerLocalMlDetector`) можно передать кастомные загрузчики для конкретных моделей (`modelLoaders`), указать модель по умолчанию и включить дополнительные возможности (обработка вложений, требования к премиум-режиму).

## Лёгкая текстовая модель

- Параметры модели публикуются в виде JSON-файла `src/assets/secure-cloud/lite-model.json`. Он содержит веса линейного классификатора (шесть коэффициентов и смещение для каждой из категорий: spam, phishing, nsfw), обученного на признаках частоты ключевых слов, NSFW-триггеров, наличия ссылок, доли заглавных символов и нормализованной длины сообщения.
- Размер JSON не превышает нескольких сотен байт, что позволяет мгновенно доставлять обновления даже при медленном соединении и хранить модель в истории git без бинарных артефактов.
- При корректировке архитектуры обновляйте JSON вместе с описанием признаков в коде (`computeFeatureVector`) и убедитесь, что веса соответствуют новой размерности.

## Очередь асинхронной обработки

- Тяжёлые операции (загрузка трансформеров, OCR изображений) выполняются через `AsyncProcessingQueue`. Очередь ограничивает параллелизм (по умолчанию 1 задача, значение можно увеличить) и устраняет дубликаты: повторное обращение с тем же cacheKey возвращает кешированный промис.
- Очередь кэширует результаты на заданный TTL, благодаря чему одно и то же сообщение не анализируется повторно даже при смене комнат.
- В браузере очередь выполняет задачи в основном потоке, но при необходимости может быть адаптирована к Web Worker/Tauri task, сохраняя совместимый API.

## Кеширование и прогрев

- При первой активации детектора JSON модели считывается через `fetch` и десериализуется в объект, который кешируется в памяти (`modelDataCache`).
- Если в среде доступен Cache Storage (`caches.open`), текст модели сохраняется в кэше браузера (`secure-cloud-lite-models`), что позволяет работать офлайн.
- После загрузки веса инициализируют простой логистический классификатор; повторные вызовы не инициируют повторную загрузку данных.
- Метод `warmup()` детектора автоматически вызывается при объединении конфигураций. Благодаря этому статус `getStatus()` отображает стадию загрузки ещё до первого события.

## Настройки пользователя

- Настройки Secure Cloud включают:
  - **Порог срабатывания** для каждой модели (0.2–0.95).
  - **Выбор языка** (`auto`, `ru`, `en`) и привязку конкретной модели к языку (`languageOverrides`).
  - **Выбор модели детектора** из каталога (`detectorModels`), например встроенной lite-модели или внешнего API.
  - **Уровни чувствительности** на уровне пользователя и организации (`userSensitivity`, `organizationSensitivity`). Повышенная чувствительность снижает порог срабатывания.
  - **Премиум-функции** (`enablePremium`), включающие локальные ML-детекторы и расширенную обработку вложений.
- Все параметры редактируются в настройках входа и в разделе «Secure Cloud отчётность». Состояние сохраняется в профиле (`SecureCloudProfile`) и применяется к активной сессии без перезапуска клиента.

## Поддержка вложений и OCR

- Локальный детектор анализирует вложения: извлекает хэши (`hashes`) и текстовые подсказки (`ocr`). Совпадения по известным хэшам усиливают риск, а распознанный текст добавляется к анализируемому телу сообщения.
- OCR запускается асинхронно через очередь, поэтому даже массивные изображения обрабатываются без блокировки UI. Текстовая подсказка (`attachment.ocrHint`) автоматически появляется в списке ключевых слов, а причина `ml_attachment_ocr` фиксируется в отчётах.
- Для будущих моделей можно расширить список известных хэшей (например, корпоративные индикаторы компрометации) через конфигурацию детектора.

## Премиум-режим

- При `enablePremium = true` локальный ML-детектор становится обязательным (`required`) и не может быть отключён пользователем.
- Если загрузка модели завершается ошибкой, статус детектора обновляется, а обработчик `onError` сессии получает подробное сообщение. Это позволяет вывести предупреждение в интерфейсе и не блокирует работу остальных детекторов.

## Агрегированная статистика и отчётность

Secure Cloud ведёт отдельный агрегированный счётчик для всех обнаруженных событий. Метрики доступны через публичные функции из `src/services/secureCloudService.ts`:

- `getSecureCloudAggregatedStats(client)` — возвращает снимок счётчиков (флаги, действия, открытые инциденты, статистика хранения).
- `subscribeSecureCloudAggregatedStats(client, listener)` — обновляет интерфейс в реальном времени при каждом изменении агрегаторов.
- `SECURE_CLOUD_RETENTION_BUCKETS` — предопределённые диапазоны хранения, используемые в отчётных графиках.
- `exportSuspiciousEventsLog(client, { format, roomId, fromTimestamp, toTimestamp })` — формирует выгрузку текущих предупреждений в `JSON` или `CSV`, поддерживает фильтрацию по комнате и диапазону времени (значение `age_ms` рассчитывается автоматически).
- `exportSecureCloudAggregatedStats(client, { format })` — возвращает текущий снимок агрегированных показателей (включая статистику по комнатам) в `JSON` или `CSV`.
- `setSecureCloudRetentionPolicy(client, days)` — синхронизирует политику хранения с локальным кэшем и автоматически очищает устаревшие события.

В компоненте `SecuritySettings` появился отдельный раздел «Secure Cloud отчётность». Он отображает:

- суммарное число флагов и открытых инцидентов;
- средний, минимальный и максимальный срок хранения закрытых событий;
- интерактивную панель `SecureCloudAnalyticsPanel` с графиками «предупреждения по комнатам», «топ причин» и гистограммой распределения хранения;
- распределение по действиям операторов (`flagged`, `acknowledged`, `expired`, `exported` и т.д.);
- актуальные согласия пользователя и элементы управления политикой хранения.

## Политика хранения и конфиденциальность

- Новое поле профиля `retentionPeriodDays` задаёт срок хранения предупреждений. Значение `0` удаляет события сразу после обработки.
- Поля `detectorModels`, `userSensitivity`, `organizationSensitivity` позволяют централизованно управлять выбранными моделями и тонкой настройкой порогов для разных групп пользователей.
- Метод `setSecureCloudRetentionPolicy` может использоваться административными скриптами для принудительной синхронизации политики (например, при переключении клиентов).
- Параметр `metadataConsent` позволяет отключить передачу технических метаданных на сервер Secure Cloud. При `false` вызов `sendMetadata` пропускается.
- Переключатель `enableAnalytics` по-прежнему регулирует отправку агрегированной аналитики. В пользовательском интерфейсе оба флага объединены в блок «Согласия и телеметрия».

## Инструкция для администраторов

1. Откройте настройки безопасности (раздел «Secure Cloud отчётность») и убедитесь, что включены только необходимые согласия.
2. Настройте политику хранения с помощью выпадающего списка. При смене значения интерфейс вызывает `setSecureCloudRetentionPolicy`, очищая события старше установленного порога.
3. Для выгрузки отчётов используйте обновлённые контролы экспорта: выбирайте комнату, диапазон (24 часа, 7/30/90 дней или «всё время») и формат (`JSON`/`CSV`). Кнопка «Экспорт аналитики Secure Cloud» вызывает `exportSecureCloudAggregatedStats` и сохраняет агрегированные показатели (включая топ-rooms и bucket'ы хранения).
4. При необходимости интеграции с внешними системами можно подписаться на `subscribeSecureCloudAggregatedStats`, чтобы получать обновления и записывать их в SIEM.
5. В случае отключения Secure Cloud (режим `disabled`) раздел продолжает отображать последнюю собранную статистику, но все элементы управления автоматически блокируются.

## Административная панель (Tauri)

В десктопном приложении доступно отдельное окно «Secure Cloud Admin». Оно открывается из настроек безопасности и использует ту же подписку `subscribeSecureCloudAggregatedStats` для live-обновлений.

- Поддерживаются переключение между учётными записями, экспорт логов и аналитики с фильтрами, а также быстрый просмотр ключевых метрик.
- Окно запускается поверх `SecureCloudAdminApp` и не требует повторного входа: активные клиенты подхватываются из общего стора.
- При отсутствии подключений отображается подсказка о необходимости авторизации в основном окне.
