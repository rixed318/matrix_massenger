# Secure Cloud: локальные ML-детекторы

Локальный ML-детектор предназначен для оперативной классификации исходящих и входящих сообщений без передачи данных в облако. Он дополняет эвристические проверки и используется автоматически при включённом премиум-режиме Secure Cloud.

## Лёгкая текстовая модель

- Параметры модели публикуются в виде JSON-файла `src/assets/secure-cloud/lite-model.json`. Он содержит веса линейного классификатора (шесть коэффициентов и смещение для каждой из категорий: spam, phishing, nsfw), обученного на признаках частоты ключевых слов, NSFW-триггеров, наличия ссылок, доли заглавных символов и нормализованной длины сообщения.
- Размер JSON не превышает нескольких сотен байт, что позволяет мгновенно доставлять обновления даже при медленном соединении и хранить модель в истории git без бинарных артефактов.
- При корректировке архитектуры обновляйте JSON вместе с описанием признаков в коде (`computeFeatureVector`) и убедитесь, что веса соответствуют новой размерности.

## Кеширование и прогрев

- При первой активации детектора JSON модели считывается через `fetch` и десериализуется в объект, который кешируется в памяти (`modelDataCache`).
- Если в среде доступен Cache Storage (`caches.open`), текст модели сохраняется в кэше браузера (`secure-cloud-lite-models`), что позволяет работать офлайн.
- После загрузки веса инициализируют простой логистический классификатор; повторные вызовы не инициируют повторную загрузку данных.
- Метод `warmup()` детектора автоматически вызывается при объединении конфигураций. Благодаря этому статус `getStatus()` отображает стадию загрузки ещё до первого события.

## Настройки пользователя

- Для локальной модели доступны два параметра:
  - **Порог срабатывания** (0.2–0.95) — минимальный риск, при котором сигнал попадает в итоговое уведомление. Значение по умолчанию: 0.6.
  - **Язык модели** — `auto`, `ru` или `en`. В режиме `auto` язык определяется по преобладающему алфавиту в сообщении.
- Управление отображается в разделе «Детекторы Secure Cloud» и сохраняется в профиле пользователя. Изменения мгновенно передаются активной сессии `startSecureCloudSession`.

## Премиум-режим

- При `enablePremium = true` локальный ML-детектор становится обязательным (`required`) и не может быть отключён пользователем.
- Если загрузка модели завершается ошибкой, статус детектора обновляется, а обработчик `onError` сессии получает подробное сообщение. Это позволяет вывести предупреждение в интерфейсе и не блокирует работу остальных детекторов.

## Агрегированная статистика и отчётность

Secure Cloud ведёт отдельный агрегированный счётчик для всех обнаруженных событий. Метрики доступны через публичные функции из `src/services/secureCloudService.ts`:

- `getSecureCloudAggregatedStats(client)` — возвращает снимок счётчиков (флаги, действия, открытые инциденты, статистика хранения).
- `subscribeSecureCloudAggregatedStats(client, listener)` — обновляет интерфейс в реальном времени при каждом изменении агрегаторов.
- `SECURE_CLOUD_RETENTION_BUCKETS` — предопределённые диапазоны хранения, используемые в отчётных графиках.
- `exportSuspiciousEventsLog(client, { format })` — формирует выгрузку текущих предупреждений в `JSON` или `CSV` (в том числе с полем `age_ms`).
- `setSecureCloudRetentionPolicy(client, days)` — синхронизирует политику хранения с локальным кэшем и автоматически очищает устаревшие события.

В компоненте `SecuritySettings` появился отдельный раздел «Secure Cloud отчётность». Он отображает:

- суммарное число флагов и открытых инцидентов;
- средний, минимальный и максимальный срок хранения закрытых событий;
- распределение по флагам (с детализацией `detectorId:reason`), а также по действиям операторов (`flagged`, `acknowledged`, `expired`, `exported` и т.д.);
- актуальные согласия пользователя и элементы управления политикой хранения.

## Политика хранения и конфиденциальность

- Новое поле профиля `retentionPeriodDays` задаёт срок хранения предупреждений. Значение `0` удаляет события сразу после обработки.
- Метод `setSecureCloudRetentionPolicy` может использоваться административными скриптами для принудительной синхронизации политики (например, при переключении клиентов).
- Параметр `metadataConsent` позволяет отключить передачу технических метаданных на сервер Secure Cloud. При `false` вызов `sendMetadata` пропускается.
- Переключатель `enableAnalytics` по-прежнему регулирует отправку агрегированной аналитики. В пользовательском интерфейсе оба флага объединены в блок «Согласия и телеметрия».

## Инструкция для администраторов

1. Откройте настройки безопасности (раздел «Secure Cloud отчётность») и убедитесь, что включены только необходимые согласия.
2. Настройте политику хранения с помощью выпадающего списка. При смене значения интерфейс вызывает `setSecureCloudRetentionPolicy`, очищая события старше установленного порога.
3. Для выгрузки отчётов используйте кнопку «Экспорт логов Secure Cloud» — она построена поверх `exportSuspiciousEventsLog` и формирует файл `secure-cloud-log-*.json|csv`.
4. При необходимости интеграции с внешними системами можно подписаться на `subscribeSecureCloudAggregatedStats`, чтобы получать обновления и записывать их в SIEM.
5. В случае отключения Secure Cloud (режим `disabled`) раздел продолжает отображать последнюю собранную статистику, но все элементы управления автоматически блокируются.
