# Security Guide

Этот документ дополняет README и описывает, как подготовить криптографическую подсистему Matrix Messenger, проверить устройства и восстановить ключи шифрования.

## Предварительные требования для десктопной сборки

1. Установите целевой таргет Rust для сборки WebAssembly:
   ```bash
   rustup target add wasm32-unknown-unknown
   ```
2. Поставьте инструмент `wasm-pack`, если он ещё не установлен:
   ```bash
   cargo install wasm-pack
   ```
3. Добавьте зависимость `@matrix-org/matrix-sdk-crypto-wasm` (ускоряет операции и позволяет использовать файловое хранилище ключей внутри Tauri):
   ```bash
   npm install @matrix-org/matrix-sdk-crypto-wasm
   ```

> ⚠️ Если приложение запускается только в браузере, шаги с wasm можно пропустить — будет использоваться IndexedDB.

## Первый запуск и bootstrap секретного хранилища

1. Выполните вход в Matrix Messenger.
2. Дождитесь завершения начальной синхронизации и откройте **Settings → Security & Devices**.
3. Убедитесь, что блоки *Cross-signing*, *Secure backup* и *Secret storage* подсвечены зелёным. Если нет — нажмите **Bootstrap cross-signing**. Клиент автоматически запустит `client.bootstrapSecretStorage()` и подготовит резервную копию ключей.
4. Сохраните recovery key, который выдаст доверенный клиент (например, Element) или ваш менеджер секретов. Этот ключ — последний способ восстановить историю, если нет других верифицированных устройств.

## Верификация и управление устройствами

- В списке **Your devices** отображаются все известные устройства. Для строк со статусом `Unverified` нажмите **Request verification**. На другом устройстве подтвердите запрос (QR-код/эмодзи-процедура).
- Кнопка **Request keys from my devices** вызывает `client.checkOwnCrossSigningTrust({ allowPrivateKeyRequests: true })`, что позволяет оперативно запросить отсутствующие ключи переписки.
- Используйте кнопку **Refresh status**, чтобы обновить состояние после действий на других клиентах.

## Восстановление ключей на новом устройстве

### С доверенным устройством
1. Войдите в Matrix Messenger на новом устройстве.
2. Откройте **Settings → Security & Devices** и нажмите **Request keys from my devices**.
3. На доверенном устройстве подтвердите запрос. После этого расшифровка старых сообщений станет доступной.

### Только с recovery key
1. При входе выберите «Use recovery key» в другом клиенте (Element/Web) или импортируйте заранее сохранённый JSON-файл резервной копии.
2. После успешного восстановления выполните в Matrix Messenger кнопку **Refresh status**, чтобы убедиться, что backup активен.

### Перезапуск после потери всех устройств
- Восстановите ключи через recovery key.
- Сразу же выполните **Bootstrap cross-signing** и сохраните новый recovery key.
- Повторно подтвердите новые устройства в доверенных клиентах.

## Troubleshooting

- Если статус `Secure backup` остаётся жёлтым, проверьте права аккаунта на homeserver и наличие подключенного identity server.
- При ошибках `Unable to bootstrap cross-signing` удалите локальное хранилище (папка приложения Tauri) и выполните вход заново — затем импортируйте ключи вручную.
- Для диагностики включите DevTools и проверьте консоль: сообщения `Automatic secret storage bootstrap failed` содержат детали, почему операция не завершилась.

Соблюдение этих шагов гарантирует, что все ваши устройства останутся доверенными, а история чатов не потеряется.
